services:
  # -----------------------------------------------------------------------------
  # 1. Nacos (注册中心 & 配置中心)
  # -----------------------------------------------------------------------------
  nacos:
    image: nacos/nacos-server:v2.3.1
    container_name: seckill-nacos
    environment:
      - MODE=standalone
      - AUTH_ENABLED=false
    ports:
      - "8848:8848"
      - "9848:9848" # gRPC 端口 (必须映射，否则 Spring Boot 3 报错)
      - "9849:9849"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/ns/instance/list?serviceName=test"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 2. MySQL 8.0 (数据库)
  # -----------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: seckill-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: seckill_order # 默认创建一个库，后续我们还会建 stock 库
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./data/mysql:/var/lib/mysql # 数据持久化挂载到当前目录下
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 3. Redis (缓存)
  # -----------------------------------------------------------------------------
  redis:
    image: redis:7.2
    container_name: seckill-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass "root" --appendonly yes
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "root", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 4. RocketMQ NameServer
  # -----------------------------------------------------------------------------
  rmqnamesrv:
    image: apache/rocketmq:5.2.0
    container_name: seckill-rmqnamesrv
    ports:
      - "9876:9876"
    command: sh mqnamesrv
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 5. RocketMQ Broker
  # -----------------------------------------------------------------------------
  broker:
    image: apache/rocketmq:5.2.0
    container_name: seckill-broker
    ports:
      - "10911:10911"
      - "10909:10909"
    environment:
      - NAMESRV_ADDR=rmqnamesrv:9876
      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m -Xmn256m
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # ⚠️ 关键配置：brokerIP1 必须设置为宿主机可访问的 IP
    # Windows Docker Desktop 使用 host.docker.internal 自动解析宿主机 IP
    command: >
      sh -c "echo 'brokerClusterName = DefaultCluster
      brokerName = broker-a
      brokerId = 0
      deleteWhen = 04
      fileReservedTime = 48
      brokerRole = ASYNC_MASTER
      flushDiskType = ASYNC_FLUSH
      autoCreateTopicEnable = true
      brokerIP1 = host.docker.internal' > ../conf/broker.conf && sh mqbroker -n rmqnamesrv:9876 -c ../conf/broker.conf"
    depends_on:
      - rmqnamesrv
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 6. RocketMQ Dashboard (可视化控制台)
  # 访问地址: http://localhost:8081
  # -----------------------------------------------------------------------------
  rmqdashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: seckill-rmq-dashboard
    ports:
      - "8081:8082"
    environment:
      - JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876
    depends_on:
      - rmqnamesrv
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 7. Sentinel Dashboard (流量监控控制台)
  # 访问地址: http://localhost:8858 (账号密码 sentinel/sentinel)
  # -----------------------------------------------------------------------------
  sentinel:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: seckill-sentinel
    ports:
      - "8858:8858"
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 8. Zipkin (分布式链路追踪)
  # 访问地址: http://localhost:9411
  # -----------------------------------------------------------------------------
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: seckill-zipkin
    ports:
      - "9411:9411"
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 9. Prometheus (监控数据采集)
  # 访问地址: http://localhost:9090
  # -----------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: seckill-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitor/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitor/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - seckill-net

  # -----------------------------------------------------------------------------
  # 10. Grafana (监控可视化面板)
  # 访问地址: http://localhost:3200 (默认账号密码 admin/admin)
  # -----------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.2
    container_name: seckill-grafana
    ports:
      - "3200:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitor/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitor/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - seckill-net

volumes:
  prometheus-data:
  grafana-data:

networks:
  seckill-net:
    driver: bridge